<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3-ease.v1.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    
    <script>
        var width = innerWidth;
        var height = 1.75 * innerHeight;
        var graphMade = false;

        const colors = ["#2e61b8", "#2eb8a6", "#eaed87", "#8ab82e", "#b8b32e", "#b8712e", "#b8452e"];
        const colorValue = d => d.properties.economy;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoNaturalEarth1()
            .scale(230)
            .translate([width / 2, height / 3.8]);
        const pathGenerator = d3.geo.path().projection(projection);
       
        const g = svg.append('g');
        let linechart;

        g.append('path')
            .attr('class', 'sphere')
            .attr('d', pathGenerator({type: "Sphere"}));
                
        svg.call(d3.behavior.zoom().on('zoom', () => {
            g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        }));

        d3.json("topoJSONdata.json", function(error, topoJSONdata) {
            d3.tsv("tsvData.tsv", function(error, tsvData) {
                const countries = topojson.feature(topoJSONdata, topoJSONdata.objects.countries);

                const rowById = {};
                tsvData.forEach(d => {
                    rowById[d.iso_n3] = d;
                });

                countries.features.forEach(d => {
                    Object.assign(d.properties, rowById[d.id])
                });

                g.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('class', 'country')
                    .attr('d', pathGenerator)
                    .attr('fill', d => colors[String(colorValue(d)).substring(0, 1) - 1])
                    .on('click', d => {
                        if (d3.event.defaultPrevented) return;
                        console.log(rowById[d.id].name);
                        data = {
                            country: rowById[d.id].name,
                            eleven: rowById[d.id].eleven,
                            twelwe: rowById[d.id].twelwe,
                            thirteen: rowById[d.id].thirteen,
                            fourteen: rowById[d.id].fourteen,
                            fifteen: rowById[d.id].fifteen,
                            sixteen: rowById[d.id].sixteen,
                            seventeen: rowById[d.id].seventeen,
                            eighteen: rowById[d.id].eighteen,
                        }
                        makeGraph(data);
                    })
                    .append('title')
                    .text(d => rowById[d.id].name)
            });    
        });

        const legendValues = ["1. Developed region: G7", "2. Developed region: nonG7", "3. Emerging region: BRIC", 
                            "4. Emerging region: MIKT", "5. Emerging region: G20", "6. Developing region", "7. Least developed region"]

        const legend = svg.append('g');
        const diameter = 10;
        const textWidth = 210;
        const space = 2;
        const rectWidth = diameter + textWidth + space * 5;
        const rectHeight = 118;

        legend.append("rect")
            .attr("x", "50")
            .attr("y", "550")
            .attr('rx', 16)
            .attr("width", rectWidth)
            .attr("height", rectHeight)
            .attr("style", "stroke: black; stroke-width: 1; fill: white; opacity: 0.7; stroke-opacity: 1");

        for (var i = 0; i < colors.length; i++) {
            legend.append("circle")
                .attr("cx", "65")
                .attr("cy", d => 550 + 15 * (i + 1))
                .attr("r", "5")
                .attr("fill", d => colors[i])

            legend.append('text')
                .attr("x", "75")
                .attr("y", 552 + 15 * (i + 1))
                .attr("dy", ".25em")
                .attr('font-family', 'sans-serif')
                .text(d => legendValues[i]);
        }

        let graph = svg.append('g');

        function makeGraph(data) {
            first = getParsedData(data.eleven);

            if (first == 0) {
                console.log("no data");
                return;
            }

            second = getParsedData(data.twelwe);
            third = getParsedData(data.thirteen);
            fourth = getParsedData(data.fourteen);
            fifth = getParsedData(data.fifteen);
            sixth = getParsedData(data.sixteen);
            seventh = getParsedData(data.seventeen);
            eighth = getParsedData(data.eighteen);

            if (graphMade) {
                graph.remove();
                linechart.remove();
                graph = svg.append('g');
            }
            
            window.scrollTo(0, document.body.scrollHeight);

            var margin = {top: 20, bottom: 70, left:40, right: 20};
            var width = 750 - margin.left - margin.right;
            var height = 500 - margin.top - margin.bottom;

            const title = data.country + " money from 2011 to 2018";
            const xValue = "Time [years]";
            const yValue = "Value [billions]";
            
            const dataX = ["2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"];
            const dataY = [first, second, third, fourth, fifth, sixth, seventh, eighth];

            
            var x = d3.scale.ordinal()
                .domain(d3.range(dataX.length))
                .rangePoints([0, width]);

            var y = d3.scale.linear()
                .domain([0, d3.max(dataY)])
                .range([height, 0]);

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .tickFormat((d, i) => dataX[i]);

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .ticks(10)

            graph.append("g")
                .attr("class", "white")
                .attr("transform", "translate(" + 0.75 * width + "," + 2.8 * height + ")")
                .call(xAxis)
                .append("text")
                .attr("x", (width / 2))
                .attr("y", 50)
                .attr("dy", ".100em")
                .attr("font-weight", "bold")
                .style("text-anchor", "middle")
                .style("fill", "white")
                .text(xValue);

            graph.append("g")
                .attr("class", "white")
                .attr("transform", "translate(" + 0.75 * width + "," + 1.8 *  height + ")")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", - (0.75 * width / 2) + 50)
                .attr("y", -70)
                .attr("dy", ".50em")
                .attr("font-weight", "bold")
                .style("text-anchor", "middle")
                .style("fill", "white")
                .text(yValue);

            var valueline = d3.svg.line()
                .interpolate("basis")
                .x(function(d, i) { return x(i); })
                .y(function(d) { return y(d); });

            linechart = graph.append("path")
                .attr("class", "line")
                .attr("transform", "translate(" + 0.75 * width + "," + 1.8 *  height + ")")
                .attr("d", valueline(dataY))
                .attr("fill", "none")
                .style("stroke", "white")
                .style("stroke-width", "5px");

            const pathLength = linechart.node().getTotalLength();

            linechart
                .attr("stroke-dashoffset", pathLength)
                .attr("stroke-dasharray", pathLength)
                .transition()
                .delay(100)
                .duration(2000)
                .attr("stroke-dashoffset", 0);

            graph.append("text")
                .attr("x", width / 2)
                .attr("y", -25)
                .attr("transform", "translate(" + 0.75 * width + "," + 1.8 *  height + ")")
                .attr("text-anchor", "middle")
                .attr("font-weight", "bold")
                .style("fill", "white")
                .style("font-size", "1.5em")
                .text(title);

            graphMade = true;
            
            console.log(first);
            console.log(second);
            console.log(third);
            console.log(fourth);
            console.log(fifth);
            console.log(sixth);
            console.log(seventh);
            console.log(eighth);
        }

        function getParsedData(data) {
            if (!data.toString().includes(",")) {
                return 0;
            }
            const commmaIndex = data.toString().indexOf(",");
            const value = data.toString().substring(0, commmaIndex);
            return parseInt(parseInt(value) / 1000000000);
        }
    </script>

</body>
</html>